<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title></title>
		<link rel="stylesheet" type="text/css" href="../css/aui.css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css" />
		<style type="text/css">
			.aui-bar-nav {
				text-align: center;
				color: #f2f2f2;
				background-color: #1db6a0;
			}
			.aui-tab-nav {
				width: 100%;
				display: box;
				display: -webkit-box;
				box-sizing: border-box;
				font-size: 14px;
				height: 40px;
				background-color: #fff;
				overflow: hidden;
			}
			.aui-tab-nav li {
				height: 40px;
				line-height: 40px;
				box-flex: 1;
				-webkit-box-flex: 1;
				box-sizing: border-box;
				text-align: center;
				color: #666;
				border-bottom: 2px solid transparent;
				width: 100%;
			}
			.aui-nnav {
				line-height: 55px;
			}
			.demo {
				font-size: 15px;
				color: #333;
				background: #fff;
			}
			.buy {
				background: #FF9800;
				color: #fff;
			}
		</style>
	</head>
	<body>
		<header class="aui-bar aui-bar-nav aui-bar-warning" id='aui-header'>
			<a class="aui-pull-left" tapmode onclick="api.closeWin();"> <span class="aui-iconfont aui-icon-left"></span>返回 </a>
			<div class="aui-title">
				地图
			</div>
		</header>
	</body>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/zepto.min.js"></script>
	<script type="text/javascript" src="../script/location.json"></script>
	<script type="text/javascript">
		function fixStatusBar(headerid, callback) {
			var header = $api.byId(headerid);
			var systemType = api.systemType;
			var systemVersion = parseFloat(api.systemVersion);
			if (systemType == "ios" || (systemType == "android" && systemVersion >= 4.4)) {
				if (systemType == "android") {
					header.style.paddingTop = '25px';
				}
				$api.fixStatusBar(header);
			} else {
				$api.fixIos7Bar(header);
			}
			var headerPos = $api.offset(header);
			if ( typeof callback == "function") {
				callback(headerPos);
			}
		}

		apiready = function() {
			//		init();
			var endlon = $api.getStorage('lon');
			var endlat = $api.getStorage('lat');
			api.parseTapmode();
			var header = $api.byId('aui-header');
			$api.fixStatusBar(header);
			var headerPos = $api.offset(header);
			var body_h = $api.offset($api.dom('body')).h;
			bMap = api.require('bMap');
			bMap.getLocation({
				accuracy : '10m',
				autoStop : true,
				filter : 1
			}, function(ret, err) {
				bMap.open({
					rect : {
						x : 0,
						y : 0,
						w : 'auto',
						h : 'auto'
					},
					center : {
						lon : ret.lon,
						lat : ret.lat
					},
					zoomLevel : 10,
					showUserLocation : true,
					// fixedOn: api.frameName,
					fixed : true
				});
				bMap.showUserLocation({
					isShow : true,
					trackingMode : 'follow'
				});
				api.alert({
                msg:endlon+",lat:"+endlat
                },function(ret,err){
                	//coding...
                });
				bMap.addAnnotations({
					annotations : [{
						id : 1,
						lon : ret.lon,
						lat : ret.lat
					}, {
						id : 2,
						lon : endlon,
						lat : endlat
					}],
					//icon: 'widget://',
					draggable : true
				});
				bMap.setZoomLevel({
					level : 15
				});
				bMap.searchRoute({
					id : 1,
					type : 'drive',
					policy : 'ecar_fee_first',
					start : {
						lon : ret.lon,
						lat : ret.lat
					},
					end : {
						lon : endlon,
						lat : endlat
					}
				}, function(ret, err) {
					bMap.drawRoute({
						id : 1,
						autoresizing : false,
						index : 0,
						styles : {
							start : {
								icon : '../image/marker_red_hd.png'
							},
							end : {
								icon : '../image/marker_red_sprite.png'
							}
						}
					});
				});
			});
			//						bMap.getCoordsFromName({
			//  							city: '山东',
			//  							address: '中国石油大学'
			//									},function(ret,err){
			//
			//										bMap.addAnnotations({
			//  						annotations: [{
			//
			//
			//      						id: 2, lon: ret.lon, lat: ret.lat
			// 										 },
			// 								 {
			//      						id: 3, lon: 116.298, lat: 40.11
			//  									}],
			// 							// icon: 'widget://',
			//  							draggable: true
			//									});
			//
			//									});
			//	        fixStatusBar("aui-header", function(headerPos) {
			//				// 打开bMap视图模块页面
			//				api.openFrame({
			//					name : 'bmap',
			//					url : './bmap.html',
			//					rect : {
			//						x : 0,
			//						y : headerPos.h,
			//						w : api.winWidth,
			//						h : 200
			//					},
			//					pageParam : {
			//					},
			//					bounces : false,
			//					vScrollBarEnabled : false,
			//					hScrollBarEnabled : false
			//				});
			//				// 操作功能列表页面
			//				api.openFrame({
			//					name : 'func',
			//					url : './func.html',
			//					rect : {
			//						x : 0,
			//						y : headerPos.h + 200,
			//						w : api.winWidth,
			//						h : api.winHeight - headerPos.h - 200
			//					},
			//					pageParam : {
			//					},
			//					bounces : false,
			//					vScrollBarEnabled : false,
			//					hScrollBarEnabled : false
			//				});
			//			});
		}
		function init() {
			bMap = api.require('bMap');
			bMap.getLocation({
				accuracy : '10m',
				autoStop : true,
				filter : 1
			}, function(ret, err) {
				if (ret) {
					lon = ret.lon;
					lat = ret.lat;
					//					api.alert({
					//						msg : lon + ",lat:" + lat
					//					}, function(ret, err) {
					//						//coding...
					//					});
					bMap.open({
						rect : {
							x : 0,
							y : 0,
							w : api.frameWidth,
							h : api.frameHeight
						},
						center : {
							lon : lon,
							lat : lat
						},
						zoomLevel : 10,
						showUserLocation : true,
						fixedOn : 'baidumapbody', // 别忘了设置这个
						fixed : true
					}, function(ret) {
						if (ret) {
							map.show();
							var endlon = $api.getStorage('lon');
							var endlat = $api.getStorage('lat');
							api.alert({
								msg : "endlon:" + endlon + ",endlat:" + endlat
							}, function(ret, err) {
								//coding...
							});
							map.searchRoute({
								id : 1,
								type : 'drive',
								policy : 'ecar_fee_first',
								start : {
									lon : lon,
									lat : lon
								},
								end : {
									lon : endlon,
									lat : endlat
								}
							}, function(ret, err) {
								if (ret.status) {
									api.alert({
										msg : JSON.stringify(ret)
									});
								}
							});
						}
						if (ret.status) {
							api.alert({
								msg : 'open方法执行成功！'
							});
						} else {
							api.alert({
								msg : 'open方法执行失败！'
							});
						}
					});
				}
			});
		};
		function getaddress() {
		}
	</script>
</html>